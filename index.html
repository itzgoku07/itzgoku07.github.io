import os
import re
import json

# --- CONFIGURATION ---
# We look for a folder named "test" in the same directory as this script
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
TEST_DIR_NAME = "test"
TEST_ROOT = os.path.join(BASE_DIR, TEST_DIR_NAME)
OUTPUT_FILE = os.path.join(BASE_DIR, "test_data.js")

def scan_tests():
    print(f"--- Scanning for tests in: {TEST_ROOT} ---")
    
    if not os.path.exists(TEST_ROOT):
        print(f"‚ùå Error: Folder '{TEST_DIR_NAME}' not found.")
        print("Please create a folder named 'test' and put your date-folders inside it.")
        return

    found_tests = []
    
    # Regex for Date Folder: DD-MM-YYYY (e.g., 01-12-2025)
    date_pattern = re.compile(r"^\d{2}-\d{2}-\d{4}$")
    
    # Regex for Test File: NN-NN-NNNN.html (e.g., 11-22-3333.html)
    file_pattern = re.compile(r"^\d+-\d+-\d+\.html$")

    # Walk through the directory
    for folder_name in os.listdir(TEST_ROOT):
        folder_path = os.path.join(TEST_ROOT, folder_name)
        
        # Check if it's a valid Date Folder
        if os.path.isdir(folder_path) and date_pattern.match(folder_name):
            print(f"üìÇ Checking Date Folder: {folder_name}")
            
            # Check files inside
            for file_name in os.listdir(folder_path):
                if file_pattern.match(file_name):
                    # We found a valid test!
                    test_code = file_name.replace(".html", "")
                    display_name = f"{folder_name} [{test_code}]"
                    
                    # Relative path for HTML to use (e.g., "test/01-12-2025/11-22-3333.html")
                    # We use forward slashes for web compatibility
                    relative_path = f"{TEST_DIR_NAME}/{folder_name}/{file_name}"
                    
                    found_tests.append({
                        "name": display_name,
                        "path": relative_path,
                        "date": folder_name
                    })
                    print(f"  ‚úÖ Found Test: {file_name}")

    # Write to a JS file that the HTML can load
    js_content = f"const AUTO_TESTS = {json.dumps(found_tests, indent=4)};"
    
    try:
        with open(OUTPUT_FILE, "w") as f:
            f.write(js_content)
        print("\n------------------------------------------------")
        print(f"üéâ Success! Found {len(found_tests)} tests.")
        print(f"üìÑ Saved list to '{OUTPUT_FILE}'")
        print("Now open 'home_page.html' - your tests will be there automatically.")
        print("------------------------------------------------")
    except Exception as e:
        print(f"‚ùå Error writing file: {e}")

if __name__ == "__main__":
    scan_tests()
    input("Press Enter to exit...")
